<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetBuffer Pro</title>
    <style>
        :root {
            --bg: #1e1e2e;
            --card: #2a2a3e;
            --text: #cdd6f4;
            --accent: #89b4fa;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: grid;
            gap: 20px;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            color: var(--accent);
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        textarea {
            width: 100%;
            height: 150px;
            background: #181825;
            color: var(--text);
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            box-sizing: border-box;
            resize: vertical;
        }

        .btn {
            background: var(--accent);
            color: #1e1e2e;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #333;
        }

        .file-info {
            display: flex;
            flex-direction: column;
        }

        .meta {
            font-size: 0.8em;
            color: #7f849c;
            margin-top: 4px;
        }

        a {
            color: var(--accent);
            text-decoration: none;
        }

        #status {
            font-size: 0.8em;
            margin-left: 10px;
            color: #a6e3a1;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* è¿›åº¦æ¡å®¹å™¨ï¼šç»™å®ƒä¸€ä¸ªç‹¬ç«‹çš„èƒŒæ™¯è‰²ï¼Œç¨å¾®åŒºåˆ«äºèƒŒæ™¯ï¼Œå½¢æˆâ€œå¡æ§½â€æ„Ÿ */
        .progress-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ ï¼šå·¦è¾¹çŠ¶æ€ï¼Œå³è¾¹ç™¾åˆ†æ¯” */
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }

        #uploadStatusTitle {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
            display: inline-block;
        }

        /* è¿›åº¦æ¡æœ¬ä½“ï¼šåœ†è§’ï¼Œæ›´ç°ä»£ */
        progress {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            border: none;
            /* å…¼å®¹æ€§è®¾ç½® */
            -webkit-appearance: none;
            appearance: none;
        }

        /* è¿›åº¦æ¡èƒŒæ™¯æ§½ */
        progress::-webkit-progress-bar {
            background-color: #181825;
            border-radius: 6px;
        }

        /* è¿›åº¦æ¡å¡«å……è‰² (Dracula Pink/Purple Gradient) */
        progress::-webkit-progress-value {
            background: linear-gradient(90deg, #cba6f7, #f38ba8);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        /* åº•éƒ¨ä¿¡æ¯æ ï¼šå·¦è¾¹è¯¦æƒ…ï¼Œå³è¾¹å–æ¶ˆæŒ‰é’® */
        .progress-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* å‚ç›´å±…ä¸­ */
            margin-top: 8px;
            font-size: 0.85em;
            color: #a6adc8;
            /* ç¨å¾®æ·¡ä¸€ç‚¹çš„æ–‡å­—é¢œè‰² */
        }

        /* è¯¦æƒ…æ–‡å­—åŒºåŸŸ */
        .progress-details {
            font-family: monospace;
            /* ç­‰å®½å­—ä½“ï¼Œæ•°å­—ä¸è·³åŠ¨ */
            opacity: 0.8;
        }

        /* ä¼˜åŒ–åçš„å–æ¶ˆæŒ‰é’®ï¼šå°å·§ã€æ”¾åœ¨å³ä¸‹è§’ */
        .btn-cancel {
            background: rgba(243, 139, 168, 0.15);
            /* æ·¡æ·¡çš„çº¢è‰²èƒŒæ™¯ */
            color: #f38ba8;
            border: 1px solid rgba(243, 139, 168, 0.3);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: #f38ba8;
            color: #1e1e2e;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <h2>ğŸ“‹ Sync Clipboard</h2>
            <textarea id="clipInput" placeholder="Type or paste content here..."></textarea>
            <div style="display: flex; align-items: center;">
                <button class="btn" onclick="pushClipboard()">Sync to Network</button>
                <span id="status">Synced!</span>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‚ File Buffer</h2>
            <div style="margin-bottom: 15px;">
                <input type="file" id="fileInput" style="display: none" onchange="uploadFile()">
                <button class="btn" onclick="document.getElementById('fileInput').click()">+ Upload File</button>
                <div id="progressContainer" class="progress-box" style="display: none;">
                    <div class="progress-header">
                        <span id="uploadStatusTitle" style="color: var(--text)">ğŸš€ Preparing...</span>
                        <span id="percentText" style="color: var(--accent)">0%</span>
                    </div>

                    <progress id="progressBar" value="0" max="100"></progress>

                    <div class="progress-footer">
                        <div id="uploadDetails" class="progress-details">
                            Waiting for data...
                        </div>
                        <button id="cancelBtn" onclick="abortUpload()" class="btn-cancel">âœ– Cancel</button>
                    </div>
                </div>
                <span id="uploadStatus" style="margin-left: 10px; font-size: 0.9em;"></span>
            </div>
            <div id="fileList"></div>
        </div>
    </div>

    <script>
        const evtSource = new EventSource("/events");

        // === 1. å…¨å±€ DOM å…ƒç´ è·å– (ä¿®å¤æ ¸å¿ƒï¼šè®©æ‰€æœ‰å‡½æ•°éƒ½èƒ½æ‰¾åˆ°è¿™äº›å…ƒç´ ) ===
        const clipInput = document.getElementById('clipInput');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusTitle = document.getElementById('uploadStatusTitle'); // é¡¶éƒ¨æ ‡é¢˜
        const percentText = document.getElementById('percentText');       // å³ä¸Šè§’ç™¾åˆ†æ¯”
        const detailsText = document.getElementById('uploadDetails');     // å·¦ä¸‹è§’è¯¦æƒ…
        const cancelBtn = document.getElementById('cancelBtn');
        const uploadStatusSpan = document.getElementById('uploadStatus'); // é‚£ä¸ªæ—§çš„å¤–éƒ¨spanï¼Œé˜²æ­¢æŠ¥é”™ä¿ç•™ç€

        let currentXhr = null;

        // === 2. SSE ç›‘å¬äº‹ä»¶ ===
        evtSource.addEventListener('clipboard', (e) => {
            const data = JSON.parse(e.data);
            if (document.activeElement !== clipInput) {
                clipInput.value = data.content;
            }
        });

        evtSource.addEventListener('files_update', (e) => {
            loadFiles();
        });

        // === 3. å‰ªè´´æ¿é€»è¾‘ ===
        async function pushClipboard() {
            await fetch('/api/clipboard', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: clipInput.value })
            });
            showStatus();
        }

        async function initClipboard() {
            const res = await fetch('/api/clipboard');
            const data = await res.json();
            clipInput.value = data.content;
        }

        // === 4. å–æ¶ˆé€»è¾‘ (ä¿®å¤ï¼šä½¿ç”¨å…¨å±€å˜é‡) ===
        function abortUpload() {
            if (currentXhr) {
                currentXhr.abort(); // è¿™ä¼šè§¦å‘ xhr.onabort
                currentXhr = null;

                // UI åé¦ˆ
                statusTitle.innerText = "ğŸ›‘ Cancelled";
                statusTitle.style.color = "#f38ba8"; // Red
                detailsText.innerText = "User aborted operation";

                // å»¶è¿Ÿå…³é—­è¿›åº¦æ¡
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    // é‡ç½®é¢œè‰²ï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰“å¼€è¿˜æ˜¯çº¢çš„
                    statusTitle.style.color = "var(--text)";
                }, 2000);
            }
        }

        // === è¾…åŠ©å‡½æ•° ===
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (!isFinite(seconds) || seconds < 0) return 'Calculating...';
            const h = Math.floor(seconds / 3600);
            if (h > 0) {
                second_in_minute = scends - h * 3600
                const m = Math.floor(second_in_minute / 60);
                const s = Math.floor(seconds % 60);
                return `${h}h ${m}m ${s < 10 ? '0' : ''}${s}s`;
            } else {
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}m ${s < 10 ? '0' : ''}${s}s`;
            }
        }

        // === 5. æ–‡ä»¶ä¸Šä¼ é€»è¾‘ ===
        async function uploadFile() {
            if (fileInput.files.length === 0) return;

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼Œå…ˆå–æ¶ˆ
            if (currentXhr) {
                currentXhr.abort();
            }

            // åˆå§‹åŒ– UI (é‡ç½®çŠ¶æ€)
            progressContainer.style.display = 'block';
            cancelBtn.style.display = 'block';
            progressBar.value = 0;
            statusTitle.innerText = `ğŸš€ Uploading: ${file.name}`;
            statusTitle.style.color = "var(--text)"; // é‡ç½®å›ç™½è‰²
            percentText.innerText = "0%";
            detailsText.innerText = "Calculating...";
            uploadStatusSpan.innerText = ""; // æ¸…ç©ºæ—§çš„å¤–éƒ¨æç¤º

            let startTime = Date.now();
            let lastTime = startTime;
            let lastLoaded = 0;
            let uploadSpeed = 0;

            const xhr = new XMLHttpRequest();
            currentXhr = xhr;
            xhr.open('POST', '/api/upload', true);

            // ç›‘å¬è¿›åº¦
            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const now = Date.now();
                    const diffTime = (now - lastTime) / 1000;

                    if (diffTime >= 0.5 || e.loaded === e.total) {
                        const diffLoaded = e.loaded - lastLoaded;
                        uploadSpeed = diffLoaded / diffTime;

                        const remainingBytes = e.total - e.loaded;
                        const etaSeconds = uploadSpeed > 0 ? remainingBytes / uploadSpeed : 0;

                        lastTime = now;
                        lastLoaded = e.loaded;

                        const percent = (e.loaded / e.total) * 100;
                        progressBar.value = percent;
                        percentText.innerText = percent.toFixed(1) + '%';

                        detailsText.innerHTML =
                            `ğŸ“¦ ${formatSize(e.loaded)}/${formatSize(e.total)} &nbsp;` +
                            `âš¡ ${formatSize(uploadSpeed)}/s &nbsp;` +
                            `â³ ${formatTime(etaSeconds)}`;
                    }

                    if (e.loaded === e.total) {
                        statusTitle.innerText = "ğŸ’¾ Server Saving...";
                        statusTitle.style.color = "#f9e2af"; // Yellow
                        detailsText.innerText = "Finalizing storage...";
                        cancelBtn.style.display = 'none'; // ä¿å­˜é˜¶æ®µä¸èƒ½å–æ¶ˆ
                    }
                }
            };

            // å®Œæˆå¤„ç†
            xhr.onload = function () {
                currentXhr = null;
                if (xhr.status === 200) {
                    statusTitle.innerText = "âœ… Complete!";
                    statusTitle.style.color = "#a6e3a1"; // Green
                    percentText.innerText = "100%";
                    detailsText.innerText = `Done in ${((Date.now() - startTime) / 1000).toFixed(1)}s`;
                    fileInput.value = ''; // æ¸…ç©ºé€‰æ‹©

                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                } else {
                    statusTitle.innerText = "âŒ Error";
                    statusTitle.style.color = "#f38ba8";
                    detailsText.innerText = "Server Error: " + xhr.statusText;
                }
            };

            // é”™è¯¯å¤„ç†
            xhr.onerror = function () {
                currentXhr = null;
                statusTitle.innerText = "âŒ Network Error";
                statusTitle.style.color = "#f38ba8";
                detailsText.innerText = "Check connection / Timeout";
            };

            // ä¸­æ–­å¤„ç† (ä¿®æ­£ï¼šè¿™é‡Œä¸éœ€è¦åšUIæ“ä½œäº†ï¼Œäº¤ç»™ abortUpload å‡½æ•°åšï¼Œé˜²æ­¢å†²çª)
            xhr.onabort = function () {
                console.log("XHR Aborted");
            };

            xhr.send(formData);
        }

        async function loadFiles() {
            const res = await fetch('/api/files');
            const files = await res.json();
            const container = document.getElementById('fileList');

            container.innerHTML = files.map(f => {
                const size = (f.size / 1024 / 1024).toFixed(2) + ' MB';
                const date = new Date(f.upload_time * 1000).toLocaleString();
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <strong>${f.filename}</strong>
                            <span class="meta">${size} â€¢ ${date}</span>
                        </div>
                        <a href="/api/download/${f.id}" class="btn" style="padding: 5px 10px; font-size: 0.9em;">â¬‡ Download</a>
                    </div>
                `
            }).join('');
        }

        function showStatus() {
            const el = document.getElementById('status');
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 2000);
        }

        // Init
        initClipboard();
        loadFiles();
    </script>
</body>

</html>